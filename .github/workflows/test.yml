name: Build Sultan Kernel (KernelSU)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download GCC 14.2.0 toolchain
        run: |
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          tar -xzf x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz

      - name: Clone kernel and AnyKernel3
        run: |
          git clone https://github.com/kerneltoast/android_kernel_google_tensynos.git
          git clone https://github.com/TheWildJames/AnyKernel3.git -b sultan-zuma

      - name: Add KernelSU
        working-directory: android_kernel_google_tensynos
        run: |
          curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -

      - name: Enable KernelSU in defconfig
        working-directory: android_kernel_google_tensynos
        run: |
          DEFCONFIG=arch/arm64/configs/zuma_defconfig

          echo "" >> $DEFCONFIG
          echo "# Sultan + KernelSU" >> $DEFCONFIG
          echo "CONFIG_KSU=y" >> $DEFCONFIG

      - name: Build kernel
        working-directory: android_kernel_google_tensynos
        run: |
          export PATH=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin:$PATH

          make zuma_defconfig

          # ðŸ”’ sanity check â€“ never build without root
          grep '^CONFIG_KSU=y' out/.config

          make -j$(nproc)

      - name: Package AnyKernel3
        run: |
          cp android_kernel_google_tensynos/out/arch/arm64/boot/Image.lz4 AnyKernel3/Image.lz4
          cat android_kernel_google_tensynos/out/google-devices/zuma/dts/*.dtb > AnyKernel3/dtb

          cd AnyKernel3
          zip -r Sultan-zuma-KernelSU.zip .

      - name: Upload kernel zip
        uses: actions/upload-artifact@v4
        with:
          name: Sultan-zuma-KernelSU
          path: AnyKernel3/Sultan-zuma-KernelSU.zip

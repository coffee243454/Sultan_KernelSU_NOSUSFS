name: Sultan
permissions:
  contents: write # Allow writing to repository contents (for pushing tags)
  actions: write # Allows triggering actions

on:
  workflow_call: # This allows this workflow to be called from another workflow
    inputs:
      codename:
        required: true
        type: string
      repo:
        required: true
        type: string
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string

jobs:
  build-kernel-sultan-kernelsu-susfs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      #- name: Maximize Build Space
      #  uses: AdityaGarg8/remove-unwanted-software@v5
      #  with:
      #    remove-dotnet: 'true'          # Frees ~2 GB
      #    remove-android: 'true'         # Frees ~9 GB
      #    remove-haskell: 'true'         # Frees ~5.2 GB
      #    remove-codeql: 'true'          # Frees ~5.4 GB
      #    remove-docker-images: 'true'   # Frees ~3.2 GB
      #    remove-large-packages: 'true'  # Frees ~3.1 GB
      #    remove-swapfile: 'true'        # Frees ~4 GB
      #    remove-cached-tools: 'false'   # Avoid unless confirmed safe
      #    verbose: 'true'                # Enable detailed logging

      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0 cross-compiler toolchain..."
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          echo "Extracting .gz file..."
          gunzip x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          echo "Extracting .tar file..."
          tar -xf x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar
          echo "GCC 14.2.0 toolchain extracted successfully"

      - name: Set CONFIG Environment Variable
        run: |
          CONFIG="android_kernel_google_tensynos"

          # Set CONFIG as an environment variable for future steps
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV

          echo "CONFIG set to: $CONFIG"

      - name: Clone AnyKernel3 and Other Dependencies
        run: |
          echo "Cloning AnyKernel3 and other dependencies..."

          ANYKERNEL_BRANCH="sultan-${{ inputs.codename }}"

          # Debug print the branches
          echo "Using branch for AnyKernel3: $ANYKERNEL_BRANCH"

          # Clone repositories using the branch names
          git clone https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH"
          git clone https://github.com/kerneltoast/android_kernel_google_tensynos --depth=1
          git clone --depth=1 https://github.com/TheSillyOk/kernel_ls_patches ok_patches
          # git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git

      - name: Add KernelSU
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          echo "Adding KernelSU..."
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s legacy
          # curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin     
          cp ../ok_patches/try.patch ./
          patch -p1 -F 3 < try.patch
          
      - name: Add KSU Configuration Settings
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          
          echo "Adding configuration settings to ${{ inputs.codename }}_defconfig..."

          # Add KSU configuration settings
          echo "CONFIG_KSU=y" >> ./arch/arm64/configs/${{ inputs.codename }}_defconfig

          # echo "CONFIG_KSU_MANUAL_SU=n" >> ./arch/arm64/configs/${{ inputs.codename }}_defconfig
          # echo "CONFIG_COMPAT=y" >> ./arch/arm64/configs/${{ inputs.codename }}_defconfig
          # echo "CONFIG_ZRAM_GS_WRITEBACK=y" >> ./arch/arm64/configs/${{ inputs.codename }}_defconfig

          # # Removing defconfig check
          # sed -i 's/check_defconfig//' ./build.config.gki
          
      - name: Apply KSU Hooks
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          # Apply additional patch
          cp ../ok_patches/sultan/scope-min-hooks-v1.6.patch ./
          patch -p1 -F 3 < scope-min-hooks-v1.6.patch
          
      - name: Run sed and perl Commands
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"

          echo "Running sed commands..."
          sed -i 's/CONFIG_LOCALVERSION="-Sultan"/CONFIG_LOCALVERSION="-SKSU"/' ./arch/arm64/configs/${{ inputs.codename }}_defconfig

      - name: Build the Kernel
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"

          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc -j$(nproc --all) ${{ inputs.codename }}_defconfig
          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc -j$(nproc --all)

      - name: Copy Images
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"

          echo "Copying Image.lz4 and concatenating DTB files..."
          cp ./out/arch/arm64/boot/Image.lz4 ../AnyKernel3/Image.lz4
          if [ "${{ inputs.codename }}" == "gs201" ]; then
            cat ./out/google-devices/gs201/dts/*.dtb > ../AnyKernel3/dtb
            #cp ./out/google-devices/gs201/dts/dtbo.img ../AnyKernel3/dtbo.img
          elif [ "${{ inputs.codename }}" == "zuma" ]; then
            cat ./out/google-devices/zuma/dts/*.dtb > ../AnyKernel3/dtb
          elif [ "${{ inputs.codename }}" == "zumapro" ]; then
            cat ./out/google-devices/zumapro/dts/*.dtb > ../AnyKernel3/dtb
          fi

      - name: Create ZIP Files for Different Formats
        run: |
          echo "Navigating to AnyKernel3 directory..."
          cd ./AnyKernel3

          # Zip the files in the AnyKernel3 directory with a new naming convention
          ZIP_NAME="${{ matrix.variant }}-${{ inputs.codename }}-A16-Sultan.zip"
          echo "Creating zip file $ZIP_NAME..."
          zip -r "../$ZIP_NAME" ./*

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.codename }}-${{ matrix.variant }}
          path: |
            *.zip

      - name: Collect .rej files
        if: ${{ always() }}
        id: collect_rej
        shell: bash
        run: |
          set -euo pipefail

          cd "$GITHUB_WORKSPACE"
          rm -rf rej
          mkdir -p rej

          found="false"
          while IFS= read -r -d '' rej_file; do
            found="true"
            original_file="${rej_file%.rej}"
            rej_rel="${rej_file#./}"
            original_rel="${original_file#./}"

            mkdir -p "rej/$(dirname "$rej_rel")"
            cp -f "$rej_file" "rej/$rej_rel"

            if [[ -f "$original_file" ]]; then
              mkdir -p "rej/$(dirname "$original_rel")"
              cp -f "$original_file" "rej/$original_rel"
            fi
          done < <(find . -type f -name '*.rej' -print0)

          echo "found=$found" >> "$GITHUB_OUTPUT"

      - name: Zip collected .rej bundle
        if: ${{ always() && steps.collect_rej.outputs.found == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          zip -r "rej-${{ inputs.codename }}-${{ matrix.variant }}.zip" rej

      - name: Upload .rej bundle
        if: ${{ always() && steps.collect_rej.outputs.found == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: rej-${{ inputs.codename }}-${{ matrix.variant }}
          path: |
            rej-${{ inputs.codename }}-${{ matrix.variant }}.zip

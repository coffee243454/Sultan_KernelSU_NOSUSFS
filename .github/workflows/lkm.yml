name: Build LKM for Sultan Kernel (Zuma)
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'kernel/**'
      - '.github/workflows/sultan-zuma-lkm.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'kernel/**'

jobs:
  build-zuma-lkm:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    
    steps:
      - name: Checkout module source
        uses: actions/checkout@v4
        with:
          path: module-source

      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0 cross-compiler toolchain..."
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          echo "Extracting .gz file..."
          gunzip x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          echo "Extracting .tar file..."
          tar -xf x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar
          echo "GCC 14.2.0 toolchain extracted successfully"

      - name: Set CONFIG Environment Variable
        run: |
          CONFIG="android_kernel_google_tensynos"
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV
          echo "CONFIG set to: $CONFIG"

      - name: Clone Sultan Kernel
        run: |
          echo "Cloning Sultan kernel repository..."
          git clone https://github.com/kerneltoast/android_kernel_google_tensynos --depth=1
          echo "Sultan kernel cloned successfully"

      - name: Prepare Kernel for Module Building
        run: |
          echo "Changing to kernel directory: $CONFIG..."
          cd "$CONFIG"
          
          echo "Configuring kernel for module building..."
          
          # Add module building configuration
          cat >> ./arch/arm64/configs/zuma_defconfig << 'EOF'
          # Module building configuration
          CONFIG_MODULES=y
          CONFIG_MODULE_UNLOAD=y
          CONFIG_MODULE_FORCE_UNLOAD=y
          CONFIG_MODVERSIONS=y
          EOF
          
          # Remove defconfig check to allow modifications
          sed -i 's/check_defconfig//' ./build.config.gki || true

      - name: Build Kernel Configuration
        run: |
          echo "Changing to kernel directory: $CONFIG..."
          cd "$CONFIG"
          
          echo "Building kernel configuration..."
          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- \
               CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc \
               ARCH=arm64 \
               -j$(nproc --all) \
               zuma_defconfig
          
          echo "Kernel configuration complete"

      - name: Prepare Module Build Environment
        run: |
          echo "Changing to kernel directory: $CONFIG..."
          cd "$CONFIG"
          
          echo "Building modules_prepare target..."
          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- \
               CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc \
               ARCH=arm64 \
               -j$(nproc --all) \
               modules_prepare
          
          echo "Module build environment prepared"

      - name: Copy Module Source to Kernel Tree
        run: |
          echo "Copying module source to kernel tree..."
          cd "$CONFIG"
          
          # Create a custom drivers directory for the module
          mkdir -p drivers/custom_lkm
          
          # Copy module source (adjust path based on your module structure)
          if [ -d "$GITHUB_WORKSPACE/module-source/kernel" ]; then
            cp -r $GITHUB_WORKSPACE/module-source/kernel/* drivers/custom_lkm/
          elif [ -d "$GITHUB_WORKSPACE/module-source/driver" ]; then
            cp -r $GITHUB_WORKSPACE/module-source/driver/* drivers/custom_lkm/
          else
            cp -r $GITHUB_WORKSPACE/module-source/* drivers/custom_lkm/
          fi
          
          echo "Module source copied to drivers/custom_lkm/"
          ls -la drivers/custom_lkm/

      - name: Build Kernel Module
        run: |
          echo "Changing to kernel directory: $CONFIG..."
          cd "$CONFIG"
          
          echo "Building kernel module for Zuma (Sultan Kernel)..."
          
          # Build the module
          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- \
               CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc \
               ARCH=arm64 \
               -j$(nproc --all) \
               M=drivers/custom_lkm \
               modules
          
          echo "=== Build completed ==="

      - name: Collect and Process Built Modules
        run: |
          echo "Collecting built kernel modules..."
          mkdir -p $GITHUB_WORKSPACE/output
          cd "$CONFIG"
          
          # Find all built .ko files
          find drivers/custom_lkm -name "*.ko" -type f | while read ko_file; do
            echo "Found module: $ko_file"
            
            # Get just the filename
            ko_name=$(basename "$ko_file")
            
            # Copy to output directory
            cp "$ko_file" "$GITHUB_WORKSPACE/output/"
            
            # Strip debug symbols
            echo "Stripping $ko_name..."
            $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-strip \
              --strip-debug \
              "$GITHUB_WORKSPACE/output/$ko_name"
            
            # Rename with Sultan-Zuma prefix
            OUTPUT_NAME="sultan-zuma_${ko_name}"
            mv "$GITHUB_WORKSPACE/output/$ko_name" "$GITHUB_WORKSPACE/output/$OUTPUT_NAME"
            
            echo "Processed: $OUTPUT_NAME"
            echo "Size: $(du -h "$GITHUB_WORKSPACE/output/$OUTPUT_NAME" | cut -f1)"
          done
          
          echo "=== All modules processed ==="
          ls -lah $GITHUB_WORKSPACE/output/

      - name: Verify Module Build
        run: |
          cd $GITHUB_WORKSPACE/output
          
          if [ -z "$(ls -A .)" ]; then
            echo "ERROR: No kernel modules were built!"
            exit 1
          fi
          
          echo "Successfully built the following modules:"
          for ko in *.ko; do
            echo "  - $ko ($(du -h "$ko" | cut -f1))"
            file "$ko"
          done

      - name: Upload Kernel Module Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sultan-zuma-lkm
          path: output/*.ko
          if-no-files-found: error

      - name: Create Release Archive
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cd output
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          tar -czf sultan-zuma-lkm-${TIMESTAMP}.tar.gz *.ko
          echo "Created archive: sultan-zuma-lkm-${TIMESTAMP}.tar.gz"

      - name: Upload Release Archive
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: sultan-zuma-lkm-release
          path: output/*.tar.gz

      - name: Display Build Summary
        if: always()
        run: |
          echo "=== Build Summary ==="
          echo "Device: Zuma (Pixel 8/8 Pro)"
          echo "Kernel: Sultan Kernel"
          echo "Toolchain: GCC 14.2.0"
          echo ""
          if [ -d "$GITHUB_WORKSPACE/output" ] && [ -n "$(ls -A $GITHUB_WORKSPACE/output/*.ko 2>/dev/null)" ]; then
            echo "✓ Build successful!"
            echo "Modules built:"
            ls -lh $GITHUB_WORKSPACE/output/*.ko
          else
            echo "✗ Build failed or no modules produced"
          fi
